# Journal - 2026-02-16

## Electric SQL POC - Day 2

### What We Did Today

Updated Electric SQL implementation based on user feedback and testing findings.

### Key Changes Made

#### 1. Initial Load - Query DB Before Sync

**Problem**: UI showed empty state while waiting for sync to complete.

**Solution**: Modified `useUserSync.ts` to load existing data from DB first, then start sync for updates:

```typescript
async function sync(callbacks) {
  // STEP 1: Load existing data from DB first
  await loadUsers()
  console.log("Initial data loaded:", data.value.length, "users")
  
  // STEP 2: Then start sync for real-time updates
  await electric.subscribe({
    table: "users",
    callbacks: { onInsert, onUpdate, onDelete }
  })
}
```

This ensures the UI has data immediately on page load, even before real-time sync completes.

#### 2. UI Reactivity - Auto-requery on Sync Events

**Problem**: Pages had to manually re-query after sync events.

**Solution**: Added `autoRefresh` option and reactive `data` array:

```typescript
// Usage with auto-refresh
const { data, refresh } = useUserSync({ autoRefresh: true })

// data is reactive - automatically updates when:
// - Initial load completes
// - onInsert event fires
// - onUpdate event fires  
// - onDelete event fires
// - Manual refresh() is called

// Or manually trigger refresh
await refresh() // Returns fresh data
```

The `data` ref is now automatically maintained and can be bound directly to UI components.

#### 3. Hybrid Mode - syncShapeToTable + ShapeStream

**Problem**: syncShapeToTable syncs data but doesn't provide granular event callbacks.

**Solution**: Added hybrid mode that combines both approaches:

```typescript
// Standard mode: syncShapeToTable only
await electric.subscribe({
  table: "users",
  callbacks: { onUpToDate, onError }
})

// Hybrid mode: syncShapeToTable + ShapeStream for UI events
await electric.subscribe({
  table: "users",
  hybridMode: true,
  callbacks: { 
    onInsert: (user) => console.log("New:", user),
    onUpdate: (user, old) => console.log("Updated:", user),
    onDelete: (id) => console.log("Deleted:", id),
    onUpToDate: () => console.log("In sync!")
  }
})
```

**How Hybrid Mode Works:**
1. `syncShapeToTable` handles automatic data sync to local PGlite table
2. `ShapeStream` provides real-time events for UI updates
3. Both run in parallel for best of both worlds

#### 4. Multiple Shapes Support

**Problem**: Could only sync one table at a time.

**Solution**: Added support for multiple simultaneous shape subscriptions:

```typescript
// Subscribe to multiple tables individually
await electric.subscribe({ 
  table: "users", 
  shapeKey: "users-sync" 
})

await electric.subscribe({ 
  table: "companies", 
  shapeKey: "companies-sync" 
})

// Or subscribe to many at once
await electric.subscribeMany([
  { table: "users", shapeKey: "users-sync" },
  { table: "companies", shapeKey: "companies-sync" },
  { table: "workspaces", shapeKey: "workspaces-sync" }
])

// Unsubscribe individually
electric.unsubscribe("users-sync")

// Or unsubscribe all
electric.unsubscribeAll()
```

### Updated Files

1. **`useUserSync.ts`**:
   - Added `UseUserSyncOptions` interface for configuration
   - Added reactive `data` state array
   - Added `refresh()` function for manual requery
   - Added `autoRefresh` option for automatic requery on sync events
   - Changed `sync()` to load from DB first, then start sync
   - Updated callbacks to support async handlers

2. **`useElectricSync.ts`**:
   - New `ShapeConfig` interface with `hybridMode` option
   - Added `hybridMode` implementation (syncShapeToTable + ShapeStream)
   - Added `subscribeMany()` for multiple shapes
   - Added `getSubscribedShapes()` and `isTableSubscribed()` helpers
   - Changed to object-based API: `subscribe({ table, callbacks })`
   - Better TypeScript support for event callbacks

### Important Configuration Notes

#### Extension Name Changed
The extension name in `usePgWorker.ts` was updated to match official Electric SQL naming:

```typescript
// Before
extensions: {
  live,
  electricSync: electricSync(),  // ❌ Incorrect
}

// After  
extensions: {
  live,
  electric: electricSync(),  // ✅ Correct - matches official docs
}
```

#### Worker Data URL
For production, PGlite workers should use data URLs. The current implementation uses a worker file path, but should be updated for production:

```typescript
// Current (development)
new Worker("/worker/pglite.worker.js", { type: "module" })

// Production (should use data URL or bundled worker)
// Reference: https://electric-sql.com/docs/guides/deployment
```

### API Usage Examples

#### Basic Usage with Auto-Refresh

```vue
<script setup>
const { data, isSyncing, isUpToDate, sync, stopSync } = useUserSync({ 
  autoRefresh: true 
})

onMounted(() => {
  sync()
})

onUnmounted(() => {
  stopSync()
})
</script>

<template>
  <div v-if="isSyncing">Loading...</div>
  <div v-else-if="isUpToDate">In sync!</div>
  
  <ul>
    <li v-for="user in data" :key="user.id">
      {{ user.name }} ({{ user.email }})
    </li>
  </ul>
</template>
```

#### Hybrid Mode for Real-Time Events

```typescript
const electric = useElectricSync()

await electric.subscribe({
  table: "users",
  hybridMode: true,
  callbacks: {
    onInsert: async (user) => {
      console.log("New user joined:", user.name)
      // Show notification, play sound, etc.
    },
    onUpdate: async (user, oldUser) => {
      console.log(`${oldUser.name} changed to ${user.name}`)
      // Update UI, show toast, etc.
    },
    onDelete: async (id) => {
      console.log("User deleted:", id)
      // Remove from UI, redirect if needed
    }
  }
})
```

#### Multiple Tables

```typescript
const electric = useElectricSync()

// Subscribe to users and companies
await electric.subscribeMany([
  { 
    table: "users", 
    shapeKey: "users",
    callbacks: { onInsert: showUserNotification }
  },
  { 
    table: "companies", 
    shapeKey: "companies",
    callbacks: { onInsert: showCompanyNotification }
  },
  { 
    table: "workspaces", 
    shapeKey: "workspaces" 
  }
])

// Check subscription status
console.log(electric.getSubscribedShapes()) // ['users', 'companies', 'workspaces']
console.log(electric.isTableSubscribed("users")) // true
```

### Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                        useUserSync                              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  Reactive   │    │   Refresh   │    │   Options   │         │
│  │  data[]     │◄───┤   ()        │    │  autoRefresh│         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                      useElectricSync                            │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │ subscribe() │    │ subscribe   │    │  Multiple   │         │
│  │ {hybridMode}│    │ Many()      │    │  shapes     │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
         │                      │
         ▼                      ▼
┌─────────────────┐    ┌─────────────────┐
│ syncShapeToTable│    │   ShapeStream   │
│ (data sync)     │    │   (UI events)   │
└─────────────────┘    └─────────────────┘
         │                      │
         └──────────┬───────────┘
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                     usePgWorker                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐         │
│  │  PGlite     │    │  Queries    │    │   Live      │         │
│  │  Worker     │    │  query()    │    │  Queries    │         │
│  │             │    │  refresh()  │    │             │         │
│  └─────────────┘    └─────────────┘    └─────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────────┐
│              IndexedDB (idb://multi-vendor-db)                  │
└─────────────────────────────────────────────────────────────────┘
```

### Next Steps

1. Test the hybrid mode with real Electric SQL server
2. Implement production worker bundling (data URL)
3. Add optimistic UI updates for mutations
4. Add offline queue for mutations when disconnected
5. Test multi-table sync scenarios

### Commits:
- (pending) - feat: Initial load from DB + auto-refresh
- (pending) - feat: Hybrid mode (syncShapeToTable + ShapeStream)
- (pending) - feat: Support multiple shape subscriptions

### Notes:
- Extension name is now "electric" (matches official docs)
- Hybrid mode provides both automatic data sync AND event callbacks
- Multiple shapes can be subscribed simultaneously with unique shapeKeys
- autoRefresh eliminates need for manual requery in most cases
