# Journal - 2026-02-16

## Electric SQL POC - Day 1

### What We Did Today

Started implementing Electric SQL (Feature 006) for real-time sync and local-first database.

#### Created Files:
1. **`usePgWorker.ts`** - PGlite Worker instance management
   - Singleton pattern for shared worker instance
   - Auto-creates tables on initialization
   - Query helpers: `query()`, `queryOne()`, `exec()`, `liveQuery()`

2. **`useElectricSync.ts`** - ShapeStream-based sync composable
   - Uses `ShapeStream` from `@electric-sql/client`
   - Event-driven: `onInsert`, `onUpdate`, `onDelete`, `onError`, `onUpToDate`
   - Pages query their own data via `usePgWorker`

3. **`useUserSync.ts`** - User-specific sync helpers
   - Query helpers for user operations
   - Sync control with callbacks
   - Logout cleanup

4. **`electric-test.vue`** - Test page for POC
   - Client-only rendering (PGlite is browser-only)
   - Demonstrates sync events + data queries

#### Key Issue Discovered & Fixed:

**Problem:** ShapeStream events fire but table queries return empty results.

**Root Cause:** PGlite client database doesn't have the tables created. `ShapeStream` only gives events - it doesn't auto-write to the table.

**Solution:** Added auto-table creation in `usePgWorker.ts`:
```typescript
// After worker init, check and create tables
for (const tableName of AUTO_CREATE_TABLES) {
  const exists = await tableExists(pg, tableName);
  if (!exists) {
    await pg.exec(TABLE_SCHEMAS[tableName]);
  }
}
```

Tables auto-created:
- `users`
- `companies`
- `company_members`
- `user_groups`
- `user_group_members`
- `workspaces`
- `folders`

### Architecture Pattern

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  useElectricSync │     │   usePgWorker    │     │    Pages        │
│  ─────────────── │     │   ────────────   │     │    ─────        │
│  ShapeStream     │────▶│   PGlite Worker  │◄────│  Query data     │
│  Sync events     │     │   Auto-creates   │     │  Manage state   │
│  (insert/update/ │     │   tables on init │     │  Display UI     │
│   delete/error)  │     │                  │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
         │                                               │
         │  Event triggers re-query                      │
         └──────────────────────────────────────────────►│
                                                        ▼
                                               Re-query table
                                               Update UI
```

### Next Steps (Tomorrow):
1. Test the auto-table creation fix
2. Verify sync events write to tables properly
3. Test CRUD operations end-to-end
4. Document the pattern for other developers

### Commits:
- `dfea73f` - refactor: Use ShapeStream pattern
- `4b8752c` - fix: auto-create tables in PGlite worker

### Notes:
- PGlite uses IndexedDB for persistence (`idb://electric-sql-poc`)
- Worker file at `/public/worker/pglite.worker.js` needs bundling for production
- Electric SQL URL: `http://localhost:3000/v1/shape` (same as Nuxt dev server)
